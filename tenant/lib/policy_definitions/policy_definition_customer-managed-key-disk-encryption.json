{
    "name": "customer-managed-key-disk-encryption",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "displayName": "Customer Managed Key Disk Encryption",
        "policyType": "Custom",
        "mode": "All",
        "description": "This policy ensures a Disk Encryption Set exists for Customer Managed Key Disk Encryption, importing a key from a Customer provided certificate.",
        "metadata": {
          "version": "1.0.0",
          "category": "Tags"
        },
        "policyRule": {
            "if": {
                "allOf": [{
                    "field": "type",
                    "equals": "Microsoft.Resources/subscriptions"
                }]
            },
            "then": {
                "effect": "deployIfNotExists",
                "details": {
                    "type": "Microsoft.Resources/resourceGroups",
                    "name": "cmk-encryption-rg",
                    "evaluationDelay": "AfterProvisioning",
                    "roleDefinitionIds": [ 
                        "/subscriptions/[field('id')]/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635"
                    ],
                    "deployment": {
                        "properties": {
                            "mode": "incremental",
                            "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "metadata": {
                                      "_generator": {
                                        "name": "bicep",
                                        "version": "0.6.18.56646",
                                        "templateHash": "14277770737016618286"
                                      }
                                    },
                                    "parameters": {
                                      "location": {
                                        "type": "string"
                                      },
                                      "sourceSubscriptionId": {
                                        "type": "string"
                                      },
                                      "sourceResourceGroupName": {
                                        "type": "string"
                                      },
                                      "sourceKeyVaultName": {
                                        "type": "string"
                                      },
                                      "sourceCmkCertificateName": {
                                        "type": "string"
                                      },
                                      "destinationSubscriptionId": {
                                        "type": "string"
                                      },
                                      "destinationKeyVaultResourceGroupName": {
                                        "type": "string"
                                      },
                                      "destinationKeyVaultName": {
                                        "type": "string"
                                      }
                                    },
                                    "resources": [
                                      {
                                        "type": "Microsoft.Resources/deployments",
                                        "apiVersion": "2020-10-01",
                                        "name": "IdentitySubscriptionModule",
                                        "subscriptionId": "[parameters('destinationSubscriptionId')]",
                                        "location": "[deployment().location]",
                                        "properties": {
                                          "expressionEvaluationOptions": {
                                            "scope": "inner"
                                          },
                                          "mode": "Incremental",
                                          "parameters": {
                                            "pfx": {
                                              "reference": {
                                                "keyVault": {
                                                  "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sourceSubscriptionId'), parameters('sourceResourceGroupName')), 'Microsoft.KeyVault/vaults', parameters('sourceKeyVaultName'))]"
                                                },
                                                "secretName": "[parameters('sourceCmkCertificateName')]"
                                              }
                                            },
                                            "destinationKeyVaultResourceGroupName": {
                                              "value": "[parameters('destinationKeyVaultResourceGroupName')]"
                                            },
                                            "destinationKeyVaultName": {
                                              "value": "[parameters('destinationKeyVaultName')]"
                                            },
                                            "location": {
                                              "value": "[parameters('location')]"
                                            }
                                          },
                                          "template": {
                                            "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                            "contentVersion": "1.0.0.0",
                                            "metadata": {
                                              "_generator": {
                                                "name": "bicep",
                                                "version": "0.6.18.56646",
                                                "templateHash": "10849218869436411669"
                                              }
                                            },
                                            "parameters": {
                                              "location": {
                                                "type": "string"
                                              },
                                              "destinationKeyVaultResourceGroupName": {
                                                "type": "string"
                                              },
                                              "destinationKeyVaultName": {
                                                "type": "string"
                                              },
                                              "pfx": {
                                                "type": "secureString"
                                              }
                                            },
                                            "resources": [
                                              {
                                                "type": "Microsoft.Resources/resourceGroups",
                                                "apiVersion": "2021-04-01",
                                                "name": "cmk-encryption-rg",
                                                "location": "[parameters('location')]"
                                              },
                                              {
                                                "type": "Microsoft.Resources/deployments",
                                                "apiVersion": "2020-10-01",
                                                "name": "CmkEncryptionModule",
                                                "resourceGroup": "cmk-encryption-rg",
                                                "properties": {
                                                  "expressionEvaluationOptions": {
                                                    "scope": "inner"
                                                  },
                                                  "mode": "Incremental",
                                                  "parameters": {
                                                    "pfx": {
                                                      "value": "[parameters('pfx')]"
                                                    },
                                                    "location": {
                                                      "value": "[parameters('location')]"
                                                    },
                                                    "destinationKeyVaultResourceGroupName": {
                                                      "value": "[parameters('destinationKeyVaultResourceGroupName')]"
                                                    },
                                                    "destinationKeyVaultName": {
                                                      "value": "[parameters('destinationKeyVaultName')]"
                                                    }
                                                  },
                                                  "template": {
                                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                    "contentVersion": "1.0.0.0",
                                                    "metadata": {
                                                      "_generator": {
                                                        "name": "bicep",
                                                        "version": "0.6.18.56646",
                                                        "templateHash": "15788932549106354844"
                                                      }
                                                    },
                                                    "parameters": {
                                                      "location": {
                                                        "type": "string",
                                                        "defaultValue": "[resourceGroup().location]"
                                                      },
                                                      "destinationKeyVaultResourceGroupName": {
                                                        "type": "string"
                                                      },
                                                      "destinationKeyVaultName": {
                                                        "type": "string"
                                                      },
                                                      "pfx": {
                                                        "type": "secureString"
                                                      }
                                                    },
                                                    "resources": [
                                                      {
                                                        "type": "Microsoft.Compute/diskEncryptionSets",
                                                        "apiVersion": "2021-08-01",
                                                        "name": "cmk-platform-des",
                                                        "location": "[parameters('location')]",
                                                        "identity": {
                                                          "type": "SystemAssigned"
                                                        },
                                                        "properties": {
                                                          "activeKey": {
                                                            "sourceVault": {
                                                              "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('destinationKeyVaultResourceGroupName')), 'Microsoft.KeyVault/vaults', parameters('destinationKeyVaultName'))]"
                                                            },
                                                            "keyUrl": "[reference(resourceId('Microsoft.Resources/deployments', 'CmkImport')).outputs.keyId.value]"
                                                          },
                                                          "encryptionType": "EncryptionAtRestWithCustomerKey",
                                                          "rotationToLatestKeyVersionEnabled": true
                                                        },
                                                        "dependsOn": [
                                                          "[resourceId('Microsoft.Resources/deployments', 'CmkImport')]"
                                                        ]
                                                      },
                                                      {
                                                        "type": "Microsoft.Resources/deployments",
                                                        "apiVersion": "2020-10-01",
                                                        "name": "CmkImport",
                                                        "properties": {
                                                          "expressionEvaluationOptions": {
                                                            "scope": "inner"
                                                          },
                                                          "mode": "Incremental",
                                                          "parameters": {
                                                            "location": {
                                                              "value": "[parameters('location')]"
                                                            },
                                                            "keyVaultName": {
                                                              "value": "[parameters('destinationKeyVaultName')]"
                                                            },
                                                            "pfx": {
                                                              "value": "[parameters('pfx')]"
                                                            },
                                                            "encryptionKeyName": {
                                                              "value": "cmk-encryption-key"
                                                            }
                                                          },
                                                          "template": {
                                                            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                            "contentVersion": "1.0.0.0",
                                                            "metadata": {
                                                              "_generator": {
                                                                "name": "bicep",
                                                                "version": "0.6.18.56646",
                                                                "templateHash": "13248594406471383478"
                                                              }
                                                            },
                                                            "parameters": {
                                                              "keyVaultName": {
                                                                "type": "string"
                                                              },
                                                              "pfx": {
                                                                "type": "secureString"
                                                              },
                                                              "location": {
                                                                "type": "string",
                                                                "defaultValue": "[resourceGroup().location]"
                                                              },
                                                              "tenantid": {
                                                                "type": "string",
                                                                "defaultValue": "[subscription().tenantId]"
                                                              },
                                                              "encryptionKeyName": {
                                                                "type": "string"
                                                              }
                                                            },
                                                            "resources": [
                                                              {
                                                                "type": "Microsoft.Resources/deploymentScripts",
                                                                "apiVersion": "2020-10-01",
                                                                "name": "CmkAzCliScript",
                                                                "location": "[parameters('location')]",
                                                                "kind": "AzureCLI",
                                                                "properties": {
                                                                  "forceUpdateTag": "1",
                                                                  "containerSettings": {
                                                                    "containerGroupName": "cmkAci"
                                                                  },
                                                                  "azCliVersion": "2.29.2",
                                                                  "environmentVariables": [
                                                                    {
                                                                      "name": "PFX",
                                                                      "secureValue": "[parameters('pfx')]"
                                                                    },
                                                                    {
                                                                      "name": "KEY_VAULT_NAME",
                                                                      "value": "[parameters('keyVaultName')]"
                                                                    },
                                                                    {
                                                                      "name": "TENANTID",
                                                                      "value": "[parameters('tenantid')]"
                                                                    },
                                                                    {
                                                                      "name": "ENCRYPTION_KEY_NAME",
                                                                      "value": "[parameters('encryptionKeyName')]"
                                                                    }
                                                                  ],
                                                                  "scriptContent": "KEY=$(echo $PFX | base64 -d | openssl pkcs12 -nocerts -nodes -passin 'pass:' | tail -n +7)\r\n      OUTPUT=$(az keyvault key import --vault-name $KEY_VAULT_NAME -n \"$${ENCRYPTION_KEY_NAME}\" --pem-string=\"$${KEY}\" --query key.kid -o tsv)\r\n      echo \"{ keyId: '$${OUTPUT}' }\" > $AZ_SCRIPTS_OUTPUT_PATH\r\n    ",
                                                                  "timeout": "PT30M",
                                                                  "cleanupPreference": "Always",
                                                                  "retentionInterval": "PT1H"
                                                                }
                                                              }
                                                            ],
                                                            "outputs": {
                                                              "keyId": {
                                                                "type": "string",
                                                                "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'CmkAzCliScript')).outputs.keyId]"
                                                              }
                                                            }
                                                          }
                                                        }
                                                      }
                                                    ]
                                                  }
                                                },
                                                "dependsOn": [
                                                  "[subscriptionResourceId('Microsoft.Resources/resourceGroups', 'cmk-encryption-rg')]"
                                                ]
                                              },
                                              {
                                                "type": "Microsoft.Resources/deployments",
                                                "apiVersion": "2020-10-01",
                                                "name": "DesAccessPolicyModule",
                                                "resourceGroup": "[parameters('destinationKeyVaultResourceGroupName')]",
                                                "properties": {
                                                  "expressionEvaluationOptions": {
                                                    "scope": "inner"
                                                  },
                                                  "mode": "Incremental",
                                                  "template": {
                                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                    "contentVersion": "1.0.0.0",
                                                    "metadata": {
                                                      "_generator": {
                                                        "name": "bicep",
                                                        "version": "0.6.18.56646",
                                                        "templateHash": "10186926019634484806"
                                                      }
                                                    },
                                                    "resources": [
                                                      {
                                                        "type": "Microsoft.Authorization/roleAssignments",
                                                        "apiVersion": "2020-04-01-preview",
                                                        "scope": "[format('Microsoft.KeyVault/vaults/{0}', 'identity-sub-kv')]",
                                                        "name": "[guid('Key Vault Reader', 'cmk-platform-des', subscription().subscriptionId, 'identity-sub-kv')]",
                                                        "properties": {
                                                          "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                                          "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, 'cmk-encryption-rg'), 'Microsoft.Compute/diskEncryptionSets', 'cmk-platform-des'), '2021-08-01', 'full').identity.principalId]",
                                                          "principalType": "ServicePrincipal"
                                                        }
                                                      },
                                                      {
                                                        "type": "Microsoft.KeyVault/vaults/accessPolicies",
                                                        "apiVersion": "2021-11-01-preview",
                                                        "name": "[format('{0}/{1}', 'identity-sub-kv', 'add')]",
                                                        "properties": {
                                                          "accessPolicies": [
                                                            {
                                                              "tenantId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, 'cmk-encryption-rg'), 'Microsoft.Compute/diskEncryptionSets', 'cmk-platform-des'), '2021-08-01', 'full').identity.tenantId]",
                                                              "objectId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, 'cmk-encryption-rg'), 'Microsoft.Compute/diskEncryptionSets', 'cmk-platform-des'), '2021-08-01', 'full').identity.principalId]",
                                                              "permissions": {
                                                                "keys": [
                                                                  "get",
                                                                  "wrapKey",
                                                                  "unwrapKey"
                                                                ]
                                                              }
                                                            }
                                                          ]
                                                        }
                                                      }
                                                    ]
                                                  }
                                                },
                                                "dependsOn": [
                                                  "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, 'cmk-encryption-rg'), 'Microsoft.Resources/deployments', 'CmkEncryptionModule')]"
                                                ]
                                              }
                                            ]
                                          }
                                        }
                                      }
                                    ]
                                  },
                            "parameters": {
                                "location": {
                                    "value": "[field('location')]"
                                },
                                "sourceSubscriptionId": {
                                    "value": "[parameters('sourceSubscriptionId')]"
                                },
                                "sourceResourceGroupName": {
                                    "value": "[parameters('sourceResourceGroupName')]"
                                },
                                "sourceKeyVaultName": {
                                    "value": "[parameters('sourceKeyVaultName')]"
                                },
                                "sourceCmkCertificateName": {
                                    "value": "[parameters('sourceCmkCertificateName')]"
                                },
                                "destinationSubscriptionId": {
                                    "value": "[field('id')]"
                                },
                                "destinationKeyVaultResourceGroupName": {
                                    "value": "[parameters('destinationKeyVaultResourceGroupName')]"
                                },
                                "destinationKeyVaultName": {
                                    "value": "[parameters('destinationKeyVaultName')]"
                                }
                            }
                        }
                    }
                }
            }
        },
        "parameters": {
            "sourceSubscriptionId": {
                "type": "String",
                "metadata": {
                    "description": "The id of the Subscription from which the Customer Managed Key should be imported",
                    "displayName": "Source Subscription ID"
                }
            },
            "sourceResourceGroupName": {
                "type": "String",
                "metadata": {
                    "description": "The name of the Resource Group containing the Key Vault from which the Customer Managed Key should be imported",
                    "displayName": "Source Resource Group Name"
                }
            },
            "sourceKeyVaultName": {
                "type": "String",
                "metadata": {
                    "description": "The name of the Key Vault from which the Customer Managed Key should be imported",
                    "displayName": "Source Key Vault Name"
                }
            },
            "sourceCmkCertificateName": {
                "type": "String",
                "metadata": {
                    "description": "The name of the Certificate within the source Key Vault which should be used as the Customer Managed Key for Disk Encryption",
                    "displayName": "Source Customer Managed Key Certificate Name"
                }
            },
            "destinationKeyVaultResourceGroupName": {
                "type": "String",
                "metadata": {
                    "description": "The name of the Resource Group containing the Key Vault within the destination Subscription which should receive the imported Customer Managed Key",
                    "displayName": "Destination Key Vault Resource Group Name"
                }
            },
            "destinationKeyVaultName": {
                "type": "String",
                "metadata": {
                    "description": "The name of the Key Vault within the destination Subscription which should receive the imported Customer Managed Key",
                    "displayName": "Destination Key Vault Name"
                }
            }
        }
    }
}
